<%
@families = Desmoservice::Families.download(desmoservice_conf, selection_idctxt: selection_idctxt, fields: 'idctxt,iddesc,libelles,attrs,famille-color')
@title="Liste des dossiers"
@with_form_js=false
@ventilation_params = {
  name: 'ventilation:contexte:simple/dossier',
  fields: 'libelles,iddesc,attrs,famille-color,idctxt',
  ignore_empty: true
}
@done = Hash.new
@families.each do |family| 
  @current_family_id = family.id
  family.subfamilies.each do |subfamily|
    @current_subfamily_id = subfamily.id
    subfamily.members.each do |member|
      @ventilation_params[:root_code] = member.id
      ventilation = Desmoservice::Ventilation.download(desmoservice_conf, @ventilation_params)
      ventilation.sectors.each do |sector|
        if sector.key == 'dossier'
          @done[@current_family_id] = true
          @done[@current_subfamily_id] = true
          @done[member.id] = sector
          break
        end
      end
    end
  end
end
%>

<div class="row">
<div class="col-md-12">
<% @families.each do |family| %>
  <%if @done.has_key?(family.id) %>
    <h2><%= text_with_key(family) %></h2>
    <% family.subfamilies.each do |subfamily|%>
      <% if @done.has_key?(subfamily.id) %>
        <h3><%= text_with_key(subfamily) %></h3>
        <ul class="ListeDescripteursPrincipaux">
          <% subfamily.members.each do |member|%>
            <% if @done.has_key?(member.id) %>
              <li>
                <p><%= span_color(member)%></p>
                <ul>
                  <% @done[member.id].liaisons.each do |liaison|%>
                    <li>
                      <p><a class="Dossier" target="_blank" href="<%= liaison['atlas:url'][0]%>"><%= liaison.text%></a></p>
                    </li>
                  <% end %>
                </ul>
              </li>
            <% end %>
          <% end %>
        </ul>
      <% end %>
    <% end %>
  <% end %>
<% end %>


</div>
</div>
